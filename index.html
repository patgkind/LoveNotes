<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Love Notes</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }
    #board {
      margin: 10px;
      border: 2px solid #ccc;
      border-radius: 8px;
      min-height: 90vh;
      position: relative;
      overflow: hidden;
    }
    .note {
      position: absolute;
      min-width: 150px;
      min-height: 100px;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      background: #fff475;
      overflow: hidden;
    }
    .note textarea {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      font-size: 14px;
    }
    .pin {
      position: absolute;
      top: 4px;
      left: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .delete-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      cursor: pointer;
      font-size: 16px;
      display: none;
    }
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
    }
    .fab button {
      background: #6200ee;
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      margin-top: 8px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    .fab-menu {
      display: none;
      flex-direction: column;
      align-items: flex-end;
      margin-bottom: 8px;
    }
    .fab.open .fab-menu {
      display: flex;
    }
    .fab-menu button {
      border-radius: 8px;
      width: auto;
      height: auto;
      padding: 6px 12px;
      font-size: 14px;
      background: #03dac5;
    }
    .edit-mode #board {
      outline: 2px dashed #6200ee;
    }
    .delete-mode #board {
      outline: 2px dashed red;
    }
  </style>
</head>
<body>
  <div id="board"></div>

  <div class="fab" id="fab">
    <div class="fab-menu">
      <button onclick="startAddNote()">Add Note</button>
      <button onclick="alert('Add Image coming soon')">Add Image</button>
      <button onclick="toggleEditMode()">Edit Mode</button>
      <button onclick="toggleDeleteMode()">Delete Mode</button>
    </div>
    <button onclick="toggleFab()">＋</button>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOgP36dXRLEoXmmg3KHUfPNuprLSVTo1k57aQYC8VkYfP4vdROq4X3lhFMvOHyQ1dgKw/exec";
    let notes = [];
    let editMode = false;
    let deleteMode = false;

    function toggleFab() {
      document.getElementById('fab').classList.toggle('open');
    }

    function toggleEditMode() {
      editMode = !editMode;
      deleteMode = false;
      document.body.classList.toggle("edit-mode", editMode);
      document.body.classList.remove("delete-mode");
      renderNotes();
    }

    function toggleDeleteMode() {
      deleteMode = !deleteMode;
      editMode = false;
      document.body.classList.toggle("delete-mode", deleteMode);
      document.body.classList.remove("edit-mode");
      renderNotes();
    }

    function startAddNote() {
      const id = Date.now().toString();
      const note = {
        id,
        text: "",
        color: "#fff475",
        x: 50, y: 50,
        pinned: false
      };
      notes.push(note);
      renderNotes();
      const el = document.getElementById(id).querySelector("textarea");
      el.removeAttribute("disabled");
      el.focus();
      el.addEventListener("blur", () => finishAddOrEdit(id, el.value, note.color));
    }

    function finishAddOrEdit(id, text, color) {
      const note = notes.find(n => n.id === id);
      if (!note) return;
      note.text = text;
      note.color = color;
      saveNote(note);
      renderNotes();
    }

    async function saveNote(note) {
      await fetch(`${SCRIPT_URL}?action=edit&id=${note.id}&text=${encodeURIComponent(note.text)}&color=${encodeURIComponent(note.color)}&x=${note.x}&y=${note.y}&pinned=${note.pinned}`);
      fetchNotes();
    }

    async function fetchNotes() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=get`);
        const data = await res.json();
        notes = data;
        renderNotes();
      } catch (e) {
        console.error("Fetch error", e);
      }
    }

    function renderNotes() {
      const board = document.getElementById("board");
      board.innerHTML = "";
      notes.forEach(note => {
        const div = document.createElement("div");
        div.className = "note";
        div.id = note.id;
        div.style.background = note.color;
        div.style.left = note.x + "px";
        div.style.top = note.y + "px";

        const textarea = document.createElement("textarea");
        textarea.value = note.text;
        textarea.disabled = true;
        div.appendChild(textarea);

        const pin = document.createElement("div");
        pin.className = "pin";
        pin.textContent = note.pinned ? "📌" : "";
        pin.onclick = () => { note.pinned = !note.pinned; saveNote(note); };
        div.appendChild(pin);

        const del = document.createElement("div");
        del.className = "delete-badge";
        del.textContent = "❌";
        if (deleteMode) del.style.display = "block";
        del.onclick = () => deleteNote(note.id);
        div.appendChild(del);

        makeDraggable(div, note);
        board.appendChild(div);
      });
    }

    async function deleteNote(id) {
      await fetch(`${SCRIPT_URL}?action=delete&id=${id}`);
      fetchNotes();
    }

    function makeDraggable(el, note) {
      let offsetX, offsetY;
      el.onmousedown = e => {
        if (editMode || deleteMode) return;
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        document.onmousemove = e2 => {
          el.style.left = e2.clientX - offsetX + "px";
          el.style.top = e2.clientY - offsetY + "px";
        };
        document.onmouseup = () => {
          document.onmousemove = null;
          document.onmouseup = null;
          note.x = parseInt(el.style.left);
          note.y = parseInt(el.style.top);
          saveNote(note);
        };
      };
    }

    fetchNotes();
  </script>
</body>
</html>
