<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Love Notes</title>
<style>
body { margin:0; height:100vh; display:flex; justify-content:center; align-items:center; background:#f0f0f0; font-family:sans-serif; }
#board { position:relative; width:calc(100% - 10px); height:calc(100% - 10px); margin:5px; background:#fff; border:5px solid #ccc; border-radius:12px; overflow:hidden; box-shadow:0 0 10px rgba(0,0,0,0.2); }
.note { position:absolute; width:200px; min-height:120px; border-radius:6px; padding:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); cursor:grab; display:flex; flex-direction:column; gap:6px; color:#000; }
.note textarea { width:100%; height:80px; border:none; resize:none; background:transparent; font-size:14px; outline:none; }
.note.adding textarea,.note.editing textarea { pointer-events:auto; }
.note img { max-width:100%; max-height:200px; object-fit:contain; border-radius:4px; }
.note .actions { display:flex; justify-content:space-between; align-items:center; }
.note .delete { cursor:pointer; color:red; font-weight:bold; display:none; }
.color-button { width:24px; height:24px; border-radius:3px; border:1px solid #999; cursor:pointer; position:absolute; top:5px; right:5px; display:none; padding:0; margin:0; }
#fab { position:fixed; bottom:20px; right:20px; }
#fabMain { width:56px; height:56px; border-radius:50%; border:none; background:#2196f3; color:#fff; font-size:28px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
#fabOptions { display:none; position:absolute; bottom:70px; right:0; flex-direction:column; gap:10px; }
#fabOptions button { padding:8px 12px; border:none; border-radius:6px; background:#4caf50; color:#fff; cursor:pointer; }
#fabOptions button:hover { background:#45a049; }
.pin-icon { width:16px; height:16px; cursor:pointer; fill:#333; }
</style>
</head>
<body>
<div id="board"></div>
<div id="fab">
  <button id="fabMain">+</button>
  <div id="fabOptions">
    <button id="addNote">Add Note</button>
    <button id="addImage">Add Image</button>
    <button id="editNotes">Edit Mode</button>
    <button id="deleteNotes">Delete Mode</button>
  </div>
</div>
<script>
const board = document.getElementById('board');
const fabMain = document.getElementById('fabMain');
const fabOptions = document.getElementById('fabOptions');
const addNoteBtn = document.getElementById('addNote');
const editNotesBtn = document.getElementById('editNotes');
const deleteNotesBtn = document.getElementById('deleteNotes');
const addImageBtn = document.getElementById('addImage');

const GS_URL = "https://script.google.com/macros/s/AKfycbyOgP36dXRLEoXmmg3KHUfPNuprLSVTo1k57aQYC8VkYfP4vdROq4X3lhFMvOHyQ1dgKw/exec";

fabMain.addEventListener('click',()=>{fabOptions.style.display=fabOptions.style.display==='flex'?'none':'flex';});
document.addEventListener('click', e=>{if(!fabMain.contains(e.target)&&!fabOptions.contains(e.target)) fabOptions.style.display='none';});

let zIndexCounter=1;
let noteMap={};

function getContrastColor(bgColor){
  const c=bgColor.charAt(0)==='#'?bgColor.substring(1,7):bgColor;
  const r=parseInt(c.substring(0,2),16), g=parseInt(c.substring(2,4),16), b=parseInt(c.substring(4,6),16);
  const lum=(0.299*r+0.587*g+0.114*b)/255; return lum>0.5?'#000000':'#ffffff';
}

function hashNote(n){ return n.Text+'|'+n.Color+'|'+n.X+'|'+n.Y+'|'+(n.ImageURL||'')+'|'+n.Pinned; }

function createOrUpdateNote(noteData){
  let note = noteMap[noteData.ID];
  const newHash = hashNote(noteData);
  if(note && note.dataset.hash===newHash) return; // unchanged

  if(!note){
    note=document.createElement('div'); noteMap[noteData.ID]=note; board.appendChild(note);
    makeDraggable(note,noteData.ID);
  }

  note.dataset.hash=newHash;
  note.style.left=noteData.X+'px'; note.style.top=noteData.Y+'px'; note.style.background=noteData.Color;
  note.style.color=getContrastColor(noteData.Color); note.style.zIndex=zIndexCounter++;
  note.innerHTML='';

  const actions=document.createElement('div'); actions.className='actions';
  const pin=document.createElementNS("http://www.w3.org/2000/svg","svg"); pin.classList.add('pin-icon');
  pin.innerHTML='<path d="M12 2C10.343 2 9 3.343 9 5c0 1.657 3 7 3 7s3-5.343 3-7c0-1.657-1.343-3-3-3zm0 9.5c-1.38 0-2.5 1.12-2.5 2.5S10.62 16.5 12 16.5 14.5 15.38 14.5 14 13.38 11.5 12 11.5z"/>';
  pin.addEventListener('click',()=>{noteData.Pinned=noteData.Pinned==='true'?'false':'true'; fetch(GS_URL+'?action=edit&id='+noteData.ID+'&pinned='+noteData.Pinned);});
  const del=document.createElement('span'); del.className='delete'; del.textContent='x';
  del.onclick=()=>{fetch(GS_URL+'?action=delete&id='+noteData.ID).then(()=>{note.remove(); delete noteMap[noteData.ID];});};
  actions.appendChild(pin); actions.appendChild(del); note.appendChild(actions);

  const textarea=document.createElement('textarea'); textarea.value=noteData.Text; textarea.style.color=getContrastColor(noteData.Color);
  textarea.addEventListener('blur',()=>{ fetch(GS_URL+'?action=edit&id='+noteData.ID+'&text='+encodeURIComponent(textarea.value)); });
  note.appendChild(textarea);

  if(noteData.ImageURL){ const img=document.createElement('img'); img.src=noteData.ImageURL; note.appendChild(img); }

  const colorButton=document.createElement('button'); colorButton.className='color-button'; colorButton.style.background=noteData.Color; colorButton.style.display='block';
  note.appendChild(colorButton);
  const hiddenInput=document.createElement('input'); hiddenInput.type='color'; hiddenInput.value=noteData.Color; hiddenInput.style.position='absolute'; hiddenInput.style.opacity=0; note.appendChild(hiddenInput);
  colorButton.addEventListener('click', e=>{hiddenInput.click(); e.stopPropagation();});
  hiddenInput.addEventListener('input', e=>{
    note.style.background=e.target.value; textarea.style.color=getContrastColor(e.target.value); colorButton.style.background=e.target.value;
    fetch(GS_URL+'?action=edit&id='+noteData.ID+'&color='+encodeURIComponent(e.target.value));
  });
}

function makeDraggable(el,id){
  let isDragging=false, offsetX, offsetY;
  el.addEventListener('mousedown', e=>{ if(['TEXTAREA','INPUT','IMG','svg','path','BUTTON'].includes(e.target.tagName)) return; isDragging=true; offsetX=e.offsetX; offsetY=e.offsetY; el.style.cursor='grabbing'; });
  document.addEventListener('mousemove', e=>{ if(!isDragging) return; const rect=board.getBoundingClientRect(); el.style.left=(e.clientX-rect.left-offsetX)+'px'; el.style.top=(e.clientY-rect.top-offsetY)+'px'; });
  document.addEventListener('mouseup', ()=>{ if(isDragging){ isDragging=false; el.style.cursor='grab'; const left=parseInt(el.style.left); const top=parseInt(el.style.top); fetch(GS_URL+`?action=edit&id=${id}&x=${left}&y=${top}`); } });
}

// Polling
async function loadNotes(){
  fetch(GS_URL+'?action=list').then(res=>res.json()).then(data=>{
    const currentIDs=new Set();
    data.forEach(n=>{createOrUpdateNote(n); currentIDs.add(n.ID);});
    Object.keys(noteMap).forEach(id=>{if(!currentIDs.has(id)){noteMap[id].remove(); delete noteMap[id];}});
  });
}
loadNotes(); setInterval(loadNotes,3000);

// FAB actions
addNoteBtn.addEventListener('click', ()=>{
  const x=60,y=60; fetch(GS_URL+`?action=add&text=&color=#fffb7d&x=${x}&y=${y}&pinned=false`).then(res=>res.json()).then(data=>{ createOrUpdateNote({ID:data.id, Text:'', Color:'#fffb7d', X:x, Y:y, Pinned:'false', ImageURL:''}); });
});
editNotesBtn.addEventListener('click', ()=>{ document.querySelectorAll('.note').forEach(note=>{ note.classList.toggle('editing'); const btn=note.querySelector('.color-button'); if(btn) btn.style.display=note.classList.contains('editing')?'block':'none'; }); });
deleteNotesBtn.addEventListener('click', ()=>{ document.querySelectorAll('.note .delete').forEach(del=>{ del.style.display=del.style.display==='inline'?'none':'inline'; }); });
addImageBtn.addEventListener('click', ()=>{
  const url=prompt('Enter image URL:'); if(url){ const x=80,y=80; fetch(GS_URL+`?action=add&text=&color=#ffffff&x=${x}&y=${y}&pinned=false&imageUrl=${encodeURIComponent(url)}`).then(res=>res.json()).then(data=>{ createOrUpdateNote({ID:data.id, Text:'', Color:'#ffffff', X:x, Y:y, Pinned:'false', ImageURL:url}); }); }
});
</script>
</body>
</html>
